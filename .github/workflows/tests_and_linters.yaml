name: Tests and Linters üß™

on: [push, pull_request]

jobs:
  tests-and-linters:
    name: "Python 3.11 on instadeep-ci"
    runs-on: instadeep-ci
    container:
      image: python:3.11

    steps:
      - name: Install OS dependencies
        run: |
          apt-get update
          apt-get install -y --no-install-recommends xvfb redis-server curl ca-certificates
          rm -rf /var/lib/apt/lists/*
      - name: Checkout repo üì¶
        uses: actions/checkout@v5

      - name: Install uv
        uses: astral-sh/setup-uv@v6

      - name: Set uv environment variables
        run: |
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"
          echo "UV_LINK_MODE=copy" >> $GITHUB_ENV
          echo "UV_SYSTEM_PYTHON=false" >> $GITHUB_ENV

      - name: Install project dependencies and activate venv
        run: |
          uv sync --locked --group all --extra cpu
          # Activate the virtual environment by adding it to PATH
          echo "$GITHUB_WORKSPACE/.venv/bin" >> $GITHUB_PATH
          echo "VIRTUAL_ENV=$GITHUB_WORKSPACE/.venv" >> $GITHUB_ENV

      - name: Git safe.directory
        run: git config --system --add safe.directory "$GITHUB_WORKSPACE"

      - name: Run linters üñåÔ∏è
        run: which python && pre-commit run --all-files --verbose

      - name: Start Redis service
        run: |
          redis-server --daemonize yes
          redis-cli ping

      - name: Run tests üß™
        env:
          EARTHDATA_USERNAME: ${{ secrets.EARTHDATA_USERNAME }}
          EARTHDATA_PASSWORD: ${{ secrets.EARTHDATA_PASSWORD }}
          REDIS_HOST: localhost
          REDIS_PORT: 6379
          REDIS_DB: 0

        run: pytest --cov --cov-config=.coveragerc --cov-report=html --cov-report=term-missing --cov-fail-under=50 -m "not auth"
